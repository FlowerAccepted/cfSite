---
import BaseLayout from "../layouts/BaseLayout.astro";
import PasswordInput from "@/components/PasswordInput.astro";
// @ts-ignore
import CorrectMarkSign from "@/components/CorrectMarkSign.astro";
const API_BASE = import.meta.env.PUBLIC_API_BASE;
---

<BaseLayout title="注册 - FAc's Site">
    <section class="title-section glass-panel">
        <h1>注册</h1>
    </section>

    <section class="glass-panel align-center">
        <input
            id="username"
            class="glass-input"
            placeholder="用户名"
            autocomplete="username"
        />
        <br />

        <form>
            <PasswordInput id="password" placeholder="密码" />
            <PasswordInput id="confirm" placeholder="确认密码" />
        </form>

        <div id="password-strength"></div>

        <p>
            <button id="register-btn" class="glass-btn" disabled>注册</button>
        </p>

        <p id="msg" class="text-red-500"></p>

        已有账号？
        <a class="basic-href" href="/login">点我登录！</a>
    </section>
    <div
        id="register-success"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
        >
        <div class="glass-panel w-2/5 h-2/5 
        flex flex-col items-center justify-center gap-10 text-center">
            <CorrectMarkSign size=128 />
            <h1>注册成功</h1>
            <button class="glass-btn justify-center" id="go-login">去登录</button>
        </div>
    </div>
    <script type="module" define:vars={{ API_BASE }}>
        import { setupAuth } from "../auth.js";
        import { initPasswordUI, initPasswordToggle } from "../password-ui.js";

        setupAuth(API_BASE);

        initPasswordToggle();
        initPasswordUI({
            passwordId: "password",
            confirmId: "confirm",
            containerId: "password-strength",
        });
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const confirmInput = document.getElementById("confirm");
        const registerBtn = document.getElementById("register-btn");

        function isUsernameValid() {
            return usernameInput.value.trim().length >= 3;
        }

        function isPasswordValid() {
            const v = passwordInput.value;
            return (
                v.length >= 8 &&
                /[A-Za-z]/.test(v) &&
                /[0-9]/.test(v) &&
                /[!@#$%^&*._-]/.test(v)
            );
        }

        function isConfirmValid() {
            return (
                confirmInput.value.length > 0 &&
                confirmInput.value === passwordInput.value
            );
        }

        function updateRegisterState() {
            const valid =
                isUsernameValid() && isPasswordValid() && isConfirmValid();

            registerBtn.disabled = !valid;
        }
        [usernameInput, passwordInput, confirmInput].forEach((el) => {
            el.addEventListener("input", updateRegisterState);
        });
        registerBtn.addEventListener("click", () => {
            if (registerBtn.disabled) return;
            register();
        });
    </script>
</BaseLayout>
